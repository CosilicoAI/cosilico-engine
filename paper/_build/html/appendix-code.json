{"version":3,"kind":"Article","sha256":"7c6163bf24cf0bda0de71905033708cf05052dff75fd5519efb05f78f726dae1","slug":"appendix-code","location":"/appendix-code.md","dependencies":[],"frontmatter":{"title":"Appendix: Code Listings","content_includes_title":false,"authors":[{"nameParsed":{"literal":"Cosilico AI","given":"Cosilico","family":"AI"},"name":"Cosilico AI","url":"https://cosilico.ai","id":"contributors-myst-generated-uid-0"}],"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true}},"github":"https://github.com/CosilicoAI/cosilico-engine","numbering":{"title":{"offset":1}},"source_url":"https://github.com/CosilicoAI/cosilico-engine/blob/main/paper/appendix-code.md","edit_url":"https://github.com/CosilicoAI/cosilico-engine/edit/main/paper/appendix-code.md","exports":[{"format":"md","filename":"appendix-code.md","url":"/build/appendix-code-32c3bd5949f142319d0e557380412621.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This appendix contains key code from the Cosilico AI training system.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GxnWOBjPnd"}],"key":"YtbsWmb7h8"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Agent Training Loop","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FwQGnwYBJE"}],"identifier":"agent-training-loop","label":"Agent Training Loop","html_id":"agent-training-loop","implicit":true,"key":"F8oMAt4fPh"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The core agentic loop that drives statute encoding:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fsuJKQ3MuP"}],"key":"Y4Gc5lypac"},{"type":"code","lang":"python","value":"class AgentTrainingLoop:\n    \"\"\"Agentic training loop using Claude with tools.\"\"\"\n\n    def __init__(\n        self,\n        model: str = \"claude-sonnet-4-20250514\",\n        max_iterations: int = 10,\n        target_accuracy: float = 0.95,\n    ):\n        self.model = model\n        self.max_iterations = max_iterations\n        self.target_accuracy = target_accuracy\n        self.client = anthropic.Anthropic()\n\n    def train(self, statute: Statute, test_cases: list[TestCase]) -> dict:\n        \"\"\"Run the agentic training loop.\"\"\"\n        messages = [\n            {\"role\": \"user\", \"content\": self._build_prompt(statute, test_cases)}\n        ]\n\n        for turn in range(self.max_iterations * 2):\n            response = self.client.messages.create(\n                model=self.model,\n                max_tokens=4096,\n                system=self._build_system_prompt(),\n                tools=TOOLS,\n                messages=messages\n            )\n\n            # Handle tool calls\n            tool_uses = [b for b in response.content if b.type == \"tool_use\"]\n\n            if not tool_uses:\n                break\n\n            for tool_use in tool_uses:\n                result = self._handle_tool_call(tool_use.name, tool_use.input)\n                # ... process results\n\n        return {\"success\": self.best_accuracy >= self.target_accuracy, ...}","position":{"start":{"line":9,"column":1},"end":{"line":50,"column":1}},"key":"xalxJAoZDb"},{"type":"heading","depth":2,"position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"children":[{"type":"text","value":"Tool Definitions","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"key":"ooVdubm9Ko"}],"identifier":"tool-definitions","label":"Tool Definitions","html_id":"tool-definitions","implicit":true,"key":"uiSk1psRvJ"},{"type":"paragraph","position":{"start":{"line":54,"column":1},"end":{"line":54,"column":1}},"children":[{"type":"text","value":"Tools available to the Claude agent:","position":{"start":{"line":54,"column":1},"end":{"line":54,"column":1}},"key":"BXtWM8H6ca"}],"key":"BQycGgsxGH"},{"type":"code","lang":"python","value":"TOOLS = [\n    {\n        \"name\": \"execute_dsl\",\n        \"description\": \"Execute Cosilico DSL code against test cases\",\n        \"input_schema\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"dsl_code\": {\"type\": \"string\"}\n            },\n            \"required\": [\"dsl_code\"]\n        }\n    },\n    {\n        \"name\": \"submit_final_code\",\n        \"description\": \"Submit final DSL code when accuracy target is met\",\n        \"input_schema\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"dsl_code\": {\"type\": \"string\"},\n                \"explanation\": {\"type\": \"string\"}\n            },\n            \"required\": [\"dsl_code\"]\n        }\n    }\n]","position":{"start":{"line":56,"column":1},"end":{"line":82,"column":1}},"key":"j862wxxqC1"},{"type":"heading","depth":2,"position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"children":[{"type":"text","value":"DSL Executor","position":{"start":{"line":84,"column":1},"end":{"line":84,"column":1}},"key":"c6o1vxhIOc"}],"identifier":"dsl-executor","label":"DSL Executor","html_id":"dsl-executor","implicit":true,"key":"l3f7UHaUOX"},{"type":"paragraph","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"children":[{"type":"text","value":"The executor that parses and runs generated DSL:","position":{"start":{"line":86,"column":1},"end":{"line":86,"column":1}},"key":"j2hTovLSPH"}],"key":"ouhQ2C7PMU"},{"type":"code","lang":"python","value":"class Executor:\n    def execute(self, code: GeneratedCode, test_cases: list[TestCase]):\n        parsed = self._parse(code.source)\n\n        results = []\n        for tc in test_cases:\n            try:\n                output = self._evaluate_formula(\n                    parsed[\"formula\"],\n                    tc.inputs,\n                    parsed[\"references\"]\n                )\n                match = abs(output - tc.expected[\"eitc\"]) <= 1.0\n                results.append(ExecutionResult(match=match, ...))\n            except Exception as e:\n                results.append(ExecutionResult(error=str(e)))\n\n        return results","position":{"start":{"line":88,"column":1},"end":{"line":107,"column":1}},"key":"cQPM4Y2Jff"},{"type":"heading","depth":2,"position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"children":[{"type":"text","value":"Oracle Interface","position":{"start":{"line":109,"column":1},"end":{"line":109,"column":1}},"key":"dc9DliIGkh"}],"identifier":"oracle-interface","label":"Oracle Interface","html_id":"oracle-interface","implicit":true,"key":"lvprFo3BBr"},{"type":"paragraph","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"children":[{"type":"text","value":"PolicyEngine oracle wrapper:","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"OUunW5jiOt"}],"key":"lPSXGq8xPT"},{"type":"code","lang":"python","value":"class PolicyEngineOracle:\n    def __init__(self, year: int = 2024):\n        from policyengine_us import Simulation\n        self.Simulation = Simulation\n        self.year = year\n\n    def evaluate(self, inputs: dict) -> dict:\n        situation = self._build_situation(inputs)\n        sim = self.Simulation(situation=situation)\n\n        return {\n            \"eitc\": float(sim.calculate(\"eitc\", self.year)),\n            \"earned_income\": float(sim.calculate(\"earned_income\", self.year)),\n            # ... other variables\n        }","position":{"start":{"line":113,"column":1},"end":{"line":129,"column":1}},"key":"weij0mMeHw"},{"type":"heading","depth":2,"position":{"start":{"line":131,"column":1},"end":{"line":131,"column":1}},"children":[{"type":"text","value":"Full Source","position":{"start":{"line":131,"column":1},"end":{"line":131,"column":1}},"key":"rzHnfG79x4"}],"identifier":"full-source","label":"Full Source","html_id":"full-source","implicit":true,"key":"hBtmcG0lar"},{"type":"paragraph","position":{"start":{"line":133,"column":1},"end":{"line":134,"column":1}},"children":[{"type":"text","value":"Complete source code available at:\n","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"p5lPPBCtfo"},{"type":"link","url":"https://github.com/CosilicoAI/cosilico-engine/tree/main/src/cosilico","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/CosilicoAI​/cosilico​-engine​/tree​/main​/src​/cosilico","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"zteX1TzAcX"}],"urlSource":"https://github.com/CosilicoAI/cosilico-engine/tree/main/src/cosilico","error":true,"key":"vb7TZCBLup"}],"key":"L8EjL2TOiO"}],"key":"OGHs5iVM23"}],"key":"yOSLCA9xK7"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Appendix: Provision Details","url":"/appendix-provisions","group":"Appendices"}}},"domain":"http://localhost:3001"}