# Tests for 26 USC Section 24 - Child Tax Credit
#
# Test cases based on IRS Publication 972, Rev. Proc. 2023-34,
# and IRS tax calculation worksheets.

metadata:
  module: statute.26.24
  description: Child Tax Credit test cases
  tags: [credits, ctc, actc, refundable_credits, irs]

tests:
  # Basic CTC calculations
  - name: Single filer, one child under 17, no phase-out
    reference: IRS Publication 972, 26 USC 24(a)
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 50000
      tax_liability: 3000
      nonrefundable_credits: 0
      earned_income: 50000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 2000
      additional_child_tax_credit: 0
      total_child_tax_credit: 2000

  - name: Married filing jointly, two children, no phase-out
    reference: IRS Publication 972
    period: 2024
    input:
      people:
        spouse1: { age: 40 }
        spouse2: { age: 38 }
        child1: { age: 8, has_valid_ssn: true }
        child2: { age: 12, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [spouse1, spouse2, child1, child2]
          filing_status: joint
      adjusted_gross_income: 150000
      tax_liability: 15000
      nonrefundable_credits: 0
      earned_income: 150000
    output:
      num_ctc_qualifying_children: 2
      child_tax_credit_before_limit: 4000
      child_tax_credit: 4000
      additional_child_tax_credit: 0
      total_child_tax_credit: 4000

  - name: Single filer, three children, no phase-out
    reference: IRS Publication 972
    period: 2024
    input:
      people:
        parent: { age: 32 }
        child1: { age: 5, has_valid_ssn: true }
        child2: { age: 9, has_valid_ssn: true }
        child3: { age: 14, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child1, child2, child3]
          filing_status: single
      adjusted_gross_income: 80000
      tax_liability: 8000
      nonrefundable_credits: 0
      earned_income: 80000
    output:
      num_ctc_qualifying_children: 3
      child_tax_credit_before_limit: 6000
      child_tax_credit: 6000
      additional_child_tax_credit: 0
      total_child_tax_credit: 6000

  # Age requirement tests
  - name: Child exactly 17 does not qualify
    reference: 26 USC 24(c)(1) - under age 17 requirement
    period: 2024
    input:
      people:
        parent: { age: 45 }
        child: { age: 17, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 60000
      tax_liability: 4000
      nonrefundable_credits: 0
      earned_income: 60000
    output:
      num_ctc_qualifying_children: 0
      child_tax_credit_before_limit: 0
      child_tax_credit: 0
      additional_child_tax_credit: 0
      total_child_tax_credit: 0

  - name: Child age 16 qualifies (under 17)
    reference: 26 USC 24(c)(1)
    period: 2024
    input:
      people:
        parent: { age: 45 }
        child: { age: 16, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 60000
      tax_liability: 4000
      nonrefundable_credits: 0
      earned_income: 60000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 2000

  # Phase-out tests
  - name: Single filer at exact phase-out threshold
    reference: 26 USC 24(b)(2)(B)(ii) - $200,000 threshold
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 200000
      tax_liability: 30000
      nonrefundable_credits: 0
      earned_income: 200000
    output:
      num_ctc_qualifying_children: 1
      ctc_phase_out_amount: 0
      child_tax_credit_before_limit: 2000
      child_tax_credit: 2000

  - name: Single filer $1,000 over threshold - partial phase-out
    reference: 26 USC 24(b)(2)(A) - $50 per $1,000
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 201000
      tax_liability: 30000
      nonrefundable_credits: 0
      earned_income: 201000
    output:
      num_ctc_qualifying_children: 1
      ctc_phase_out_amount: 50
      child_tax_credit_before_limit: 1950
      child_tax_credit: 1950

  - name: Single filer $40,000 over threshold - fully phased out
    reference: 26 USC 24(b)(2) - credit phases out completely at $240,000
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 240000
      tax_liability: 40000
      nonrefundable_credits: 0
      earned_income: 240000
    output:
      num_ctc_qualifying_children: 1
      ctc_phase_out_amount: 2000
      child_tax_credit_before_limit: 0
      child_tax_credit: 0
      total_child_tax_credit: 0

  - name: Joint filer at threshold - no phase-out
    reference: 26 USC 24(b)(2)(B)(i) - $400,000 joint threshold
    period: 2024
    input:
      people:
        spouse1: { age: 40 }
        spouse2: { age: 38 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [spouse1, spouse2, child]
          filing_status: joint
      adjusted_gross_income: 400000
      tax_liability: 70000
      nonrefundable_credits: 0
      earned_income: 400000
    output:
      num_ctc_qualifying_children: 1
      ctc_phase_out_amount: 0
      child_tax_credit_before_limit: 2000
      child_tax_credit: 2000

  - name: Joint filer $20,000 over threshold - partial phase-out
    reference: 26 USC 24(b)(2)
    period: 2024
    input:
      people:
        spouse1: { age: 40 }
        spouse2: { age: 38 }
        child: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [spouse1, spouse2, child]
          filing_status: joint
      adjusted_gross_income: 420000
      tax_liability: 80000
      nonrefundable_credits: 0
      earned_income: 420000
    output:
      num_ctc_qualifying_children: 1
      ctc_phase_out_amount: 1000
      child_tax_credit_before_limit: 1000
      child_tax_credit: 1000

  # Tax liability limitation tests
  - name: CTC limited by tax liability
    reference: 26 USC 24(d)(1) - credit limited to tax liability
    period: 2024
    input:
      people:
        parent: { age: 30 }
        child1: { age: 5, has_valid_ssn: true }
        child2: { age: 8, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child1, child2]
          filing_status: single
      adjusted_gross_income: 40000
      tax_liability: 1500
      nonrefundable_credits: 0
      earned_income: 40000
    output:
      num_ctc_qualifying_children: 2
      child_tax_credit_before_limit: 4000
      child_tax_credit: 1500
      # ACTC kicks in for the remaining $2,500

  # Additional Child Tax Credit (ACTC) tests
  - name: ACTC - earned income based refundable portion
    reference: 26 USC 24(h)(5)(A) - 15% of earned income over $2,500
    period: 2024
    input:
      people:
        parent: { age: 28 }
        child: { age: 6, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 25000
      tax_liability: 500
      nonrefundable_credits: 0
      earned_income: 25000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 500
      # Unused CTC: $1,500
      # 15% of ($25,000 - $2,500) = $3,375
      # Min($1,500, $3,375, $1,700) = $1,500
      additional_child_tax_credit: 1500
      total_child_tax_credit: 2000

  - name: ACTC - limited by refundable max per child
    reference: 26 USC 24(h)(5)(B) - $1,700 max refundable per child (2024)
    period: 2024
    input:
      people:
        parent: { age: 30 }
        child: { age: 4, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 50000
      tax_liability: 0
      nonrefundable_credits: 0
      earned_income: 50000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 0
      # Unused CTC: $2,000
      # 15% of ($50,000 - $2,500) = $7,125
      # Max refundable: $1,700
      # Min($2,000, $7,125, $1,700) = $1,700
      additional_child_tax_credit: 1700
      total_child_tax_credit: 1700

  - name: ACTC - limited by earned income formula
    reference: 26 USC 24(h)(5)(A)(i)
    period: 2024
    input:
      people:
        parent: { age: 25 }
        child: { age: 3, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 10000
      tax_liability: 0
      nonrefundable_credits: 0
      earned_income: 10000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 0
      # Unused CTC: $2,000
      # 15% of ($10,000 - $2,500) = $1,125
      # Max refundable: $1,700
      # Min($2,000, $1,125, $1,700) = $1,125
      additional_child_tax_credit: 1125
      total_child_tax_credit: 1125

  - name: ACTC - earned income below threshold
    reference: 26 USC 24(h)(5)(A)(i) - must exceed $2,500
    period: 2024
    input:
      people:
        parent: { age: 22 }
        child: { age: 2, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 2000
      tax_liability: 0
      nonrefundable_credits: 0
      earned_income: 2000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 0
      # 15% of ($2,000 - $2,500) = 15% of $0 = $0
      additional_child_tax_credit: 0
      total_child_tax_credit: 0

  - name: ACTC - multiple children, high earned income
    reference: 26 USC 24(h)(5)
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child1: { age: 3, has_valid_ssn: true }
        child2: { age: 6, has_valid_ssn: true }
        child3: { age: 10, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child1, child2, child3]
          filing_status: single
      adjusted_gross_income: 40000
      tax_liability: 500
      nonrefundable_credits: 0
      earned_income: 40000
    output:
      num_ctc_qualifying_children: 3
      child_tax_credit_before_limit: 6000
      child_tax_credit: 500
      # Unused CTC: $5,500
      # 15% of ($40,000 - $2,500) = $5,625
      # Max refundable: 3 * $1,700 = $5,100
      # Min($5,500, $5,625, $5,100) = $5,100
      additional_child_tax_credit: 5100
      total_child_tax_credit: 5600

  # SSN requirement tests
  - name: Child with ITIN does not qualify
    reference: 26 USC 24(e) - SSN required
    period: 2024
    input:
      people:
        parent: { age: 35 }
        child: { age: 10, has_valid_ssn: false }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 50000
      tax_liability: 3000
      nonrefundable_credits: 0
      earned_income: 50000
    output:
      num_ctc_qualifying_children: 0
      child_tax_credit_before_limit: 0
      child_tax_credit: 0
      additional_child_tax_credit: 0
      total_child_tax_credit: 0

  # Edge case: zero tax liability but sufficient earned income for ACTC
  - name: Zero tax liability with ACTC
    reference: 26 USC 24(d), 24(h)(5)
    period: 2024
    input:
      people:
        parent: { age: 30 }
        child: { age: 8, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 30000
      tax_liability: 0
      nonrefundable_credits: 0
      earned_income: 30000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 0
      # 15% of ($30,000 - $2,500) = $4,125
      # Min($2,000, $4,125, $1,700) = $1,700
      additional_child_tax_credit: 1700
      total_child_tax_credit: 1700

  # Historical year test (2023)
  - name: 2023 values - lower refundable max
    reference: Rev. Proc. 2022-38
    period: 2023
    input:
      people:
        parent: { age: 30 }
        child: { age: 8, has_valid_ssn: true }
      tax_units:
        tax_unit:
          members: [parent, child]
          filing_status: single
      adjusted_gross_income: 50000
      tax_liability: 0
      nonrefundable_credits: 0
      earned_income: 50000
    output:
      num_ctc_qualifying_children: 1
      child_tax_credit_before_limit: 2000
      child_tax_credit: 0
      # 2023 refundable max: $1,600
      additional_child_tax_credit: 1600
      total_child_tax_credit: 1600

properties:
  - name: CTC is non-negative
    for_all:
      variables: [child_tax_credit, additional_child_tax_credit, total_child_tax_credit]
      constraint: |
        child_tax_credit >= 0 and
        additional_child_tax_credit >= 0 and
        total_child_tax_credit >= 0

  - name: CTC does not exceed credit per child times children
    for_all:
      variables: [child_tax_credit_before_limit, num_ctc_qualifying_children]
      constraint: |
        child_tax_credit_before_limit <= num_ctc_qualifying_children * 2000

  - name: Nonrefundable CTC limited by tax liability
    for_all:
      variables: [child_tax_credit, tax_liability, nonrefundable_credits]
      constraint: |
        child_tax_credit <= max(0, tax_liability - nonrefundable_credits)

  - name: ACTC limited by refundable max per child
    for_all:
      variables: [additional_child_tax_credit, num_ctc_qualifying_children, refundable_max]
      constraint: |
        additional_child_tax_credit <= num_ctc_qualifying_children * refundable_max

  - name: Total CTC equals sum of refundable and nonrefundable
    for_all:
      variables: [total_child_tax_credit, child_tax_credit, additional_child_tax_credit]
      constraint: |
        total_child_tax_credit == child_tax_credit + additional_child_tax_credit

  - name: Phase-out is $50 per $1,000 over threshold
    for_all:
      where:
        filing_status: single
        adjusted_gross_income: [200000, 210000]
      constraint: |
        ctc_phase_out_amount(adjusted_gross_income: 210000) ==
        ctc_phase_out_amount(adjusted_gross_income: 200000) + 500

  - name: Joint filers have higher threshold than single
    for_all:
      where:
        adjusted_gross_income: [250000]
        num_ctc_qualifying_children: [1]
      constraint: |
        child_tax_credit_before_limit(filing_status: joint) >
        child_tax_credit_before_limit(filing_status: single)
